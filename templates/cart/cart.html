<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>Bookmazon</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico"/>
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/slide.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/book.css') }}" rel="stylesheet"/>
    <style>
        .content-body {
            min-height: 80vh;
        }
        .quantity-input {
            width: 80px;
        }
        .quantity-number-input {
            text-align: center;
        }
        td, th {
            vertical-align: middle;
        }

        .cart-table-container {
            max-height: 700px;
            overflow-y: auto;
        }
        .overflow-hidden {
            overflow: hidden;
        }



    </style>
</head>
<body>
{% include '/product/header.html' %}
<div class="container mt-5 content-body">
    <h2>購物車</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"
                aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endwith %}
    {% if cart_items|length > 0 %}
    <div class="cart-table-container">
        <table class="table">
            <thead>
            <tr>
                <th class="col-1"></th>
                <th class="col-1"></th>
                <th class="col-4">書名</th>
                <th class="col-2">單價</th>
                <th class="col-4">數量</th>
                <th class="col-1">小計</th>
            </tr>
            </thead>
            <tbody>
            {% for cart_item, item, book in cart_items %}
            <tr>
                <td>
                    <form action="{{ url_for('cartController.remove_from_cart', cart_item_id=cart_item.cart_item_id) }}"
                          method="post">
                        <button type="submit" class="btn-close"></button>
                    </form>
                </td>
                <td><a href="{{ url_for('productController.getDetailProductInfo', item_id=item.item_id) }}"><img
                        class="card-img-top mb-5 mb-md-0" src="{{ url_for('static', filename=book.book_image_path) }}"
                        alt="{{ book.book_name }}" style="max-width: 70%; height: 70%;"></a></td>
                <td>{{ book.book_name }}</td>
                <td id="book-price">{{ book.book_price }}</td>
                <td>
                    <button type="button" class="quantity-decrease btn btn-light">-</button>
                    <input type="number" name="quantity-{{ cart_item.cart_item_id }}"
                           min="1" value="{{ cart_item.quantity }}" data-max-stock="{{ item.book_count }}"
                           class="quantity-number-input" data-cart-item-id="{{ cart_item.cart_item_id }}">
                    <button type="button" class="quantity-increase btn btn-light">+</button>
                </td>
                <td id="subTotal-price" data-book-price="{{ book.book_price }}">{{ cart_item.quantity * book.book_price
                    }}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-end">
        <h4 class="me-2">總計：</h4>
        <h4 id="total-price">{{ total_price }}</h4>
    </div>
    <div class="d-flex justify-content-between mt-3">
        <!-- 繼續購物-->
        <a href="{{ url_for('productController.getProducts') }}" class="btn btn-secondary" id="checkout-button">繼續購物</a>

        <!-- 商品結帳-->
        <a href="{{ url_for('cartController.checkout') }}" class="btn btn-secondary" id="continue-shopping-button">前往結帳</a>
    </div>
    {% else %}
    <div class="alert alert-warning" role="alert">
        {{current_user.user.user_account}}的購物車是空的！
    </div>
    <a href="{{ url_for('productController.getProducts') }}" class="btn btn-primary">返回商店</a>
    {% endif %}
</div>
{% include 'common/footer.html' %}

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {

    const quantityDecreaseButtons = document.querySelectorAll(".quantity-decrease");
    const quantityIncreaseButtons = document.querySelectorAll(".quantity-increase");
    const quantityNumberInputs = document.querySelectorAll(".quantity-number-input");
    const subTotalPriceElements = document.querySelectorAll("#subTotal-price");
    const totalPriceElement = document.getElementById("total-price");
    const removeButtons = document.querySelectorAll(".btn-close");

    // Add event listeners for decrease buttons
    quantityDecreaseButtons.forEach(function(button, index) {
        button.addEventListener("click", function() {
            updateQuantity(index, -1);
        });
    });

    // Add event listeners for increase buttons
    quantityIncreaseButtons.forEach(function(button, index) {
        button.addEventListener("click", function() {
            updateQuantity(index, 1);
        });
    });

    // Attach the update function to button clicks
    document.getElementById('checkout-button').addEventListener('click', updateCartQuantities);
    document.getElementById('continue-shopping-button').addEventListener('click', updateCartQuantities);

    function updateQuantity(index, change) {
        const currentQuantity = parseInt(quantityNumberInputs[index].value);
        const maxStock = parseInt(quantityNumberInputs[index].getAttribute("data-max-stock"));
        let newQuantity = currentQuantity + change;

        // Ensure the new quantity is within the allowed range
        if (newQuantity < 1) {
            newQuantity = 1;
        } else if (newQuantity > maxStock) {
            newQuantity = maxStock;
        }

        // Update the quantity input
        quantityNumberInputs[index].value = newQuantity;

        // Update the subtotal price
        const bookPrice = parseFloat(subTotalPriceElements[index].dataset.bookPrice);
        const subTotalPrice = newQuantity * bookPrice;
        subTotalPriceElements[index].textContent = subTotalPrice.toFixed(2);

        // Update the total price
        updateTotalPrice();
    }

    // Function to update the total price based on subtotal prices
    function updateTotalPrice() {
        const subTotalPrices = Array.from(subTotalPriceElements).map(function(element) {
            return parseFloat(element.textContent);
        });

        const totalPrice = subTotalPrices.reduce(function(acc, val) {
            return acc + val;
        }, 0);

        totalPriceElement.textContent = totalPrice.toFixed(2);
    }

    // Function to update cart quantities
    function updateCartQuantities() {
        const cartItems = [];
        document.querySelectorAll('.quantity-number-input').forEach(input => {
            cartItems.push({
                cart_item_id: input.getAttribute('data-cart-item-id'),
                quantity: input.value
            });
        });

        fetch('/cart/update_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({cartItems: cartItems})
        }).then(response => response.json())
        .then(data => {
            if(data.success) {
                // Handle success - maybe update UI or alert the user
                console.log("Update was successful", data);
                // Optionally, you could navigate away or refresh the page here

            } else {
                // Handle failure - alert the user, possibly retry
                console.error("Update failed", data);
                alert("Failed to update cart. Please try again!");
            }
        }).catch(error => {
            // Handle network errors or other fetch issues
            console.error("Network or other error", error);
            alert("An error occurred. Please try again!");
        });
    }


});
</script>

</html>